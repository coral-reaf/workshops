# ワークショップ演習 - アップグレードが元に戻されている事の確認

## 目次

- [ワークショップ演習 - アップグレードが元に戻されている事の確認](#ワークショップ演習---アップグレードが元に戻されている事の確認)
- [目次](#目次)
- [目標](#目標)
- [ガイド](#ガイド)
- [Step 1 - ロールバック後の状態](#step-1---ロールバック後の状態)
- [Step 2 - 次のステップ](#step-2---次のステップ)
- [まとめ](#まとめ)

## 目標

* アップグレードによって発生したすべての変更と影響がロールバック後に元に戻されていることを確認する
* スナップショット スコープのトピックを再確認する
* ロールバック後の次のステップを検討する

## ガイド

前の演習では、ペット アプリ サーバーの 1 つをロールバックしました。ここで、この結果がどこにあるのかを詳しく調べ、そこからどこへ進むかを検討します。

### Step 1 - ロールバック後の状態

このStepでは、すべてがアップグレード前と同じ状態に戻っていると想定して、アップグレード後にホストで行った観察を繰り返します。

- 前の演習では、RHEL バージョンが元に戻っていることを確認しました。シェル プロンプトで、`cat /etc/redhat-release` や `uname -r` などのコマンドを使用して、OS リリース情報とカーネル バージョンを出力し、これを確認できます。RHEL Web コンソールを更新して、システム概要ページに表示される RHEL バージョンを確認することもできます。

- オプションの [インスタンスを破棄](../3.1-rm-rf/README.ja.md) 演習でペット アプリ サーバーに何らかの損傷を与えた場合、その証拠は見つかりません。

たとえば、`rm -rf /*` コマンドですべてを削除しましたか、それとも `rpm -e --nodeps glibc` コマンドで標準 C ライブラリを削除しましたか? OS を破壊しようとした努力が無駄になりました!

JDK ランタイム パッケージを削除してペット アプリケーションを壊しましたか? `rpm -q temurin-17-jdk` コマンドで確認すると、パッケージがインストールされていることがわかります。

ディスクがいっぱいになった場合は、`df -h /` コマンドで確認します。十分な空き容量があることが報告されます。

- オプションの [ペット アプリのデプロイ](../1.6-my-pet-app/README.ja.md) 演習から Spring Pet Clinic サンプル アプリケーションをインストールした場合は、ブラウザーの Web ユーザー インターフェイスを更新して、ロールバック後に正しく実行されていることを確認します。

> **注意**
>
> ワークショップ用にプロビジョニングされた EC2 インスタンスの外部 IP アドレスは動的に割り当てられるため (つまり、DHCP を使用)、再起動後に Web ユーザー インターフェイスの URL が変更される可能性があります。その場合は、アプリケーション サーバーのシェル プロンプトで次のコマンドを実行して、アプリケーション Web ユーザー インターフェイスの新しい URL を特定します。
>
> ```
> echo "http://$(curl -s ifconfig.me):8080"
> ```

アップグレード後に追加または変更したアプリケーション データを探すと、それらの変更がすべて失われていることがわかります。これは、ロールバック プレイブックによって実装されたスナップショット スコープについて何を物語っているのでしょうか。

ビジネス側は変更が失われることを喜ばないでしょう。そのため、すべてのスコープ スナップショットを実行することを選択した場合は、アプリケーション データへのリスクをビジネス側に認識させておく必要があります。

### Step 2 - 次のステップ

ロールバックの理由が何であれ、次のStepは次に何をするかを決めることです。

- ロールバックした理由は、Leapp のアップグレード自体に障害があったため、または標準ツールやエージェントに対処するためのカスタム自動化に障害があったためかもしれません。その場合は、何が起こったかを評価し、その経験を活用して自動化を改善し、今後同様の問題が発生するのを防ぎます。

堅牢な自動化の開発は反復的なプロセスです。失敗を早く受け入れることが大切であることを忘れないでください。自動化の開発初期段階でのアップグレードの失敗は想定内であり、修正が必要な点について通知されます。自動ロールバック機能があれば、堅牢なプレイブックの開発を加速できます。

- アップグレード後にアプリケーションへの影響が発見されたためにロールバックした場合はどうなるでしょうか。この場合、アプリ チームが影響の原因を調査することが重要です。原因がわかったら、ロールバックして、学んだことを次回の問題回避に適用します。

アプリケーションへの影響の原因を理解することも反復的なプロセスです。アプリ チームは、開発サーバーとテスト サーバーをアップグレードする際に、アプリケーションの問題を完全に評価するために必要な時間をかけ、必要に応じて頻繁にロールバックする必要があります。このように下位の環境を使用して、本番環境に移行する前に全員が十分に準備できるようにします。

- ロールバック後も、アップグレード前に生成された最後のアップグレード前レポートは引き続き利用できます。ロールバック後に大きな変更が行われていない場合は、別のアップグレードを試す前に新しいアップグレード前レポートを生成する必要はありません。

## 結論

この演習では、ロールバック後のペット アプリ サーバーの状態を確認し、いくつかの異なるシナリオの次のステップを検討しました。

ワークショップの次の最後の演習では、学習した内容を復習し、ワークショップラボ環境で試してみたいその他の事項を探ります。

---

**ナビゲーション**

[前の演習](../3.2-rollback/README.ja.md) - [次の演習](../3.4-conclusion/README.ja.md)

[ホーム](../README.ja.md)
