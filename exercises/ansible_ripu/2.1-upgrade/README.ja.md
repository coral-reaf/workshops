# ワークショップ演習 - OS アップグレード ジョブの実行

## 目次

- [ワークショップ演習 - OS アップグレードジョブの実行](#workshop-exercise---os-アップグレードジョブの実行)
  - [目次](#目次)
  - [目標](#目標)
  - [ガイド](#ガイド)
    - [Step 1 - アップグレードワークフロージョブテンプレートの起動](#step-1---アップグレードワークフロージョブテンプレートの起動)
    - [Step 2 - Leapp の詳細の確認](#step-2---leapp-の詳細の確認)
  - [まとめ](#まとめ)

## 目的

* ワークフロージョブ テンプレートを使用してスナップショットを作成し、アップグレードを開始する
* Leapp フレームワークが RHEL OS をアップグレードする方法について学習する

## ガイド

RHEL インプレースアップグレードオートメーションフェーズを開始する準備ができました:

![自動化アプローチ ワークフロー図アップグレード手順が強調表示されています](images/ripu-workflow-hl-upgrade.svg)

このフェーズでは、ワークフロー ジョブ テンプレートを使用してアップグレード Playbook が実行されます。最初のプレイブックは、アップグレードで問題が発生した場合にロールバックするために使用できるスナップショットを作成します。スナップショットが作成されると、2 番目の Playbook は Leapp ユーティリティを使用して、ホストを新しい RHEL メジャー バージョンにアップグレードするアップグレードを実行します。

### Step 1 - アップグレードワークフロージョブテンプレートの起動

ペットアプリケーションサーバーの RHEL インプレースアップグレードを開始します。アップグレード中は、ホストにログインしたりアプリケーションにアクセスしたりすることはできません。アップグレードが完了すると、ホストは新しくアップグレードされた RHEL メジャー バージョンで再起動します。

アップグレードには通常 1 時間もかかりませんが、シャットダウンが遅いアプリケーションや、再起動サイクルが長いベア メタル ホストがある場合は、さらに時間がかかることがあります。ワークショップラボ環境用にプロビジョニングされたクラウドインスタンスは、従来のエンタープライズ アプリケーション サーバーに比べて非常に軽量であるため、かなり迅速にアップグレードされます。

- Web ブラウザの AAP Web UI タブに戻ります。リソース > テンプレート に移動して、"AUTO / 02 アップグレード" ジョブ テンプレートを開きます。次のようになります。

![アップグレード ジョブ テンプレートの詳細ビューを表示する AAP Web UI](images/upgrade_template.svg)

- "起動" ボタンをクリックすると、変数プロンプトから始まるジョブを送信するためのプロンプトが表示されます。

![AAP Web UI のアップグレード ジョブ変数プロンプト](images/upgrade_vars_prompt.svg)

- 変数設定を変更する必要はないので、"次へ" ボタンをクリックして先に進みます。

![AAP Web UI のアップグレード ジョブ サーベイ プロンプト](images/upgrade_survey_prompt.svg)

- 次に、インベントリグループを選択するように求めるジョブ テンプレートサーベイプロンプトが表示されます。 1 つのジョブを使用してすべてのペットアプリホストをアップグレードするため、"ALL_rhel" オプションを選択し、"次へ" ボタンをクリックします。これにより、選択したジョブ オプションと変数設定のプレビューが表示されます。

![AAP Web UI でのアップグレード ジョブのプレビュー](images/upgrade_preview.svg)

- ジョブ プレビューに問題がなければ、"起動" ボタンを使用してジョブを開始します。

### Step 2 - Leapp の詳細の確認

アップグレード ジョブを起動すると、AAP Web UI は、開始したジョブのワークフロー ジョブ出力ページに自動的に移動します。このジョブは完了するまでに最大 20 分かかるため、この時間を利用して、Leapp フレームワークが OS を次の RHEL メジャー バージョンにアップグレードする方法についてもう少し学習しましょう。

- Leapp フレームワークは、RHEL OS パッケージのアップグレードのみを担当することに注意してください。標準エージェント、ツール、ミドルウェアなどのアップグレードに必要な追加タスクは、組織の環境の特定の要件に対応するために開発するアップグレード プレイブックに含める必要があります。

- Leapp フレームワークは、一連のフェーズに従って RHEL インプレース アップグレードを実行します。これらのフェーズは次の図に示されています。

![Leapp アップグレード フロー図](images/inplace-upgrade-workflow-gbg.svg)

- RHEL インプレース アップグレードの手順は、Leapp アクターと呼ばれるモジュールに実装されています。Leapp フレームワークはメッセージ駆動型です。アクターの実行は、それより前に実行されている他のアクターによって生成されたデータに依存します。初期フェーズで実行されているアクターは、システムをスキャンして、アップグレード前のレポートに結果を追加するメッセージと、アップグレード中に決定を下したり変更を適用したりするために後のアクターが使用するメッセージを生成します。

- 各フェーズには、before、main、after の 3 つの定義済みステージが含まれます。before ステージと after ステージは、フェーズ内の他のアクターとの関係でアクターが実行されるタイミングをさらに絞り込むために使用されます。アクターは、実行されるフェーズとステージを定義するためにタグ付けされます。

- フェーズには、Old System、Interim System、New System の 3 つのグループがあります。Old System グループのフェーズは、既存の RHEL インストール バージョンで実行されます。Interim System フェーズは、InitRamStart フェーズがホストをアップグレード initramfs 環境に再起動した後に開始されます。この環境では、ネットワークとその他のサービスは開始されません。この時点で、すべての RHEL パッケージをアップグレードできます。すべてのパッケージがアップグレードされると、もう一度再起動すると、ホストが新しい RHEL メジャー バージョンで起動し、FirstBoot フェーズが開始されます。この最終フェーズでは、ネットワーク アクセスを必要とするアップグレード後のアクターをいくつか実行し、その後アップグレードが行われます。

- これらのフェーズを理解しておくと、Leapp のアップグレード中に問題をトラブルシューティングする必要がある場合に役立ちます。また、Leapp カスタム アクターを開発する予定がある場合は特に重要です。Leapp フレームワークのアーキテクチャと内部設計の詳細については、アップストリームの [Leapp 開発者向けドキュメント](https://leapp.readthedocs.io/en/latest/index.html) を参照してください。

## まとめ

この演習では、スナップショットを作成し、ペット アプリ サーバーのアップグレードを開始するためのワークフロー ジョブ テンプレートを起動しました。RHEL OS のアップグレード中に何が起こっているかをよりよく理解するために、Leapp フレームワークについてさらに学習しました。

次の演習では、スナップショットの仕組みについて詳しく学習します。

---

**Navigation**

[Previous Exercise](../1.6-my-pet-app/README.ja.md) - [Next Exercise](../2.2-snapshots/README.ja.md)

[Home](../README.md)
