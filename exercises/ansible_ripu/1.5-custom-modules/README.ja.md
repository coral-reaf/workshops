# ワークショップ演習 - カスタムモジュール

## 目次

- [ワークショップ演習 - カスタムモジュール](#ワークショップ演習---カスタムモジュール)
  - [目次](#目次)
  - [オプション演習](#オプション演習)
  - [目標](#目標)
  - [ガイド](#ガイド)
    - [Step 1 - カスタムモジュールとは](#step-1---カスタムモジュールとは)
    - [Step 2 - Leapp カスタムアクターをインストールする](#step-2---leapp-カスタムアクターのインストール)
    - [Step 3 - 新しいアップグレード前レポートを生成する](#step-3---新しいアップグレード前レポートの生成)
    - [Step 4 - インプレースアップグレードのカスタマイズの詳細](#step-4---インプレースアップグレードのカスタマイズの詳細)
  - [まとめ](#まとめ)

## オプション演習

これはオプションの演習です。ワークショップを正常に完了するために必須ではありませんが、時間に余裕がある場合は実行することをお勧めします。次のセクションに記載されている目標を確認して、この演習を実行するか、次の演習に進むかを決定します。

* [演習 1.6 - (オプション) ペットアプリケーションのデプロイ](../1.6-my-pet-app/README.ja.md)
* [演習 2.1 - RHEL アップグレードジョブの実行](../2.1-upgrade/README.ja.md)

## 目標

* カスタム モジュールとは何かを学習する
* 追加のアップグレード前チェックを実装するために Leapp カスタム アクターをインストールする
* 独自のカスタム アクターの作成についてさらに学習するための場所を確認する

## ガイド

### Step 1 - カスタムモジュールとは

カスタム モジュールとは、企業固有の特別な要件を満たすために RHEL インプレース アップグレード自動化アプローチに重ねることができるカスタム機能を指す一般的な用語です。

- たとえば、組織では、システム メンテナンスを行う前に従う必要がある標準のポリシー セットを確立している場合があります。その場合、ポリシーに準拠していない条件が検出されると、アップグレード前のインヒビターを発生させる Leapp カスタム アクターを実装できます。

- カスタム モジュールのもう 1 つの使用例は、標準の RHEL サーバー ビルドに含めるサードパーティのツールとエージェントを処理することです。たとえば、構成の収束に Chef を使用する場合、アップグレード プレイブックに追加のタスクを実装して、Chef クライアント パッケージを更新し、新しい OS バージョンで必要となる Chef ノード属性と実行リストに必要な変更を加えることができます。

- さまざまな組織の多様な要件に合わせてロジックと自動化を設計および実装する方法についての単一の青写真がないため、"カスタム モジュール" という一般的な用語を使用します。カスタム モジュールの要件では、Leapp カスタム アクター、カスタム Ansible 自動化、または両方を使用した統合設計が必要になる場合があります。

- カスタム Leapp アクターは、必要な追加のアップグレード前チェックを実装するのに最適です。これらのチェックの結果は、Leapp フレームワークによって生成されるアップグレード前レポートにシームレスに含まれるためです。カスタム Leapp アクターは、Leapp アップグレードの中間システム (initrd) フェーズ中に実行する必要がある自動化タスクにも使用する必要があります。

- Leapp カスタム アクターの開発は、プレイブックにタスクを追加するだけの場合ほど簡単ではありません。そのため、ほとんどのカスタム自動化要件は、Ansible を使用して実現するのが最適です。タスクは、RHEL OS アップグレードを実際に実行するために から `infra.leapp` コレクション `upgrade` ロールをインポートするタスクの前後にアップグレード プレイブックに含めることができます。

### Step 2 - Leapp カスタムアクターのインストール

GitHub リポジトリ [oamg/leapp-supplements](https://github.com/oamg/leapp-supplements) には、サンプルのカスタム アクターのコレクションがあります。そのうちの 1 つを使用して、アップグレード前のレポートにカスタム チェックを追加する方法を説明します。

- インストールするサンプルのカスタム アクターは、架空の組織の "reboot hygiene" ポリシーに準拠しているかどうかのチェックを実装します。アクターは、次のいずれかの条件が検出された場合、阻害リスクを報告してアップグレードをブロックします。

- ホストの稼働時間が、ポリシーで定義された最大値を超えています。

- 実行中のカーネル バージョンが、ブートローダーで構成されているデフォルトのカーネル バージョンと一致していません。

- /boot ディレクトリに、前回の再起動以降に変更されたファイルがあります。

- VS Code ブラウザー タブに移動して、ターミナル セッションを開きます。どのように実行したかを思い出す必要がある場合は、[演習 1.1、ステップ 2](../1.1-setup/README.ja.md#step-2---ターミナルセッションを開く) を参照してください。

- `ssh` コマンドを使用して、ペット アプリ サーバーの 1 つにログインします。例:

```
ssh tidy-bengal
```

- 次に、カスタム アクターを提供する RPM パッケージをインストールします。ペット アプリ サーバーで次のコマンドを実行します:

```
sudo yum -y --enablerepo=leapp-supplements install leapp-upgrade-\*-supplements
```

> **注**
>
> このカスタム アクターをデモンストレーションするためだけに、パッケージを手動でインストールしています。エンタープライズ規模でカスタム アクターを展開する準備ができている場合は、分析プレイブックの冒頭にパッケージのインストールを含めます。

- パッケージが正常にインストールされた場合に表示される出力の例を次に示します。

  ```
  Resolving Dependencies
  --> Running transaction check
  ---> Package leapp-upgrade-el7toel8-supplements.noarch 0:1.0.0-47.demo.el7 will be installed
  --> Finished Dependency Resolution

  Dependencies Resolved

  ==========================================================================================
   Package                             Arch    Version             Repository          Size
  ==========================================================================================
  Installing:
   leapp-upgrade-el7toel8-supplements  noarch  1.0.0-47.demo.el7   leapp-supplements   12 k

  Transaction Summary
  ==========================================================================================
  Install  1 Package

  Total download size: 12 k
  Installed size: 18 k
  Downloading packages:
  leapp-upgrade-el7toel8-supplements-1.0.0-47.demo.el7.noarch.rpm    |  12 kB  00:00:00
  Running transaction check
  Running transaction test
  Transaction test succeeded
  Running transaction
    Installing : leapp-upgrade-el7toel8-supplements-1.0.0-47.demo.el7.noarch            1/1
    Verifying  : leapp-upgrade-el7toel8-supplements-1.0.0-47.demo.el7.noarch            1/1

  Installed:
    leapp-upgrade-el7toel8-supplements.noarch 0:1.0.0-47.demo.el7

  Complete!
  ```

- カスタム アクターの動作を実証するために、ポリシーに違反する条件を作成し、阻害要因の検出が報告されるようにします。次のコマンドを使用します:

```
sudo touch /boot/policy-violation
```

このコマンドにより、/boot の下に、最後の再起動よりも後のタイムスタンプを持つファイルが作成されました。このホストは、再起動の衛生ポリシーに準拠しなくなりました。

### Step 3 - 新しいアップグレード前レポートの生成

これで、カスタム アクターからのチェックを含むアップグレード前レポートを実行する準備ができました。

- AAP Web UI ブラウザー タブに戻ります。[リソース] > [テンプレート] に移動し、[AUTO / 01 Analysis] ジョブ テンプレートを開きます。[インベントリ グループの選択] プロンプトで [ALL_rhel] オプションを選択してジョブを起動します。

- ジョブが完了したら、RHEL Web コンソールに戻り、リモート ホスト メニューを使用して、カスタム アクター パッケージをインストールしたペット アプリ サーバーに移動します。アップグレード前レポートを更新します。これで、新しい阻害物質の検出結果が表示されるはずです。例:

![Pre-upgrade report showing inhibitor finding from custom actor](images/reboot_hygiene.svg)

- 検出結果をクリックして詳細ビューを開きます。ここでは、検出結果の説明と、再起動してくださいという丁寧な修復のヒントを含む概要が表示されます。

![Finding details reported by reboot hygiene custom actor](images/reboot_hygiene_finding.svg)

- ホストを再起動して、阻害要因の検出を解決します。例:

```
sudo reboot
```

- 再起動後に、別のアップグレード前レポートを生成します。新しいレポートで、この阻害要因の検出が消えていることを確認します。

### Step 4 - インプレースアップグレードのカスタマイズの詳細

インプレース アップグレード用のカスタム リポジトリまたはカスタム アクターを使用してサードパーティ パッケージのアップグレードを処理するためのベスト プラクティスを理解するには、ナレッジ記事 [Customizing your Red Hat Enterprise Linux in-place upgrade](https://access.redhat.com/articles/4977891) をお読みください。

Leapp カスタム アクターの開発に関する細かい詳細は、このワークショップの範囲外です。以下に、自分でさらに学習するために確認できるリソースをいくつか示します。

- [Leapp の開発者向けドキュメント](https://leapp.readthedocs.io/en/latest/): このドキュメントでは、Leapp フレームワークの内部ワークフロー アーキテクチャと、独自のカスタム アクターを開発およびテストする方法について説明します。

- [Leapp ダッシュボード](https://oamg.github.io/leapp-dashboard/#/): ここを調べて、検討しているカスタム アクターの機能がメインストリームの Leapp フレームワークにまだ存在していないことを確認してください。

- [oamg/leapp-supplements](https://github.com/oamg/leapp-supplements): サンプルのカスタム アクターを見つけて独自のアクターを投稿できる GitHub リポジトリ。カスタム アクター RPM パッケージ用の `Makefile` もあります。

## まとめ

この演習では、カスタム モジュールは Leapp カスタム アクターにすることも、アップグレード プレイブックに追加されたカスタム タスクにすることもできることを学びました。追加のアップグレード前チェックを備えたサンプルのカスタム アクターを提供する RPM パッケージのインストールを実演し、実際に動作する新しいアップグレード前レポートを生成しました。

---

**ナビゲーター**

[前の演習](../1.4-remediate/README.ja.md) - [次の演習](../1.6-my-pet-app/README.ja.md)

[ホーム](../README.ja.md)
