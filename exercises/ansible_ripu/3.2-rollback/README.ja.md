# ワークショップ演習 - ロールバックジョブの実行

## 目次

- [ワークショップ演習 - ロールバックジョブの実行](#ワークショップ演習---ロールバックジョブの実行)
  - [目次](#目次)
  - [目標](#目標)
  - [ガイド](#ガイド)
    - [Step 1 - ロールバックジョブテンプレートを起動](#step-1---ロールバックジョブテンプレートを起動)
    - [Step 2 - ロールバックジョブ出力の観察](#step-2---ロールバックジョブ出力の観察)
    - [Step 3 - RHEL バージョンを確認](#step-3---rhel-バージョンを確認)
  - [まとめ](#まとめ)

## 目標

* Ansible Playbook を使用して RHEL アップグレードをロールバックする方法を実演する
* RHEL メジャーバージョンが元に戻っていることを確認する

## ガイド

この演習では、RHEL のアップグレードが失敗した場合や、アップグレードによってアプリケーションに予期しない影響が生じた場合と同じように、ペット アプリケーション サーバーの 1 つをロールバックする方法を説明します。

これで、RHEL インプレース自動化ワークフローの調査が始まりました。

![ロールバック プレイブックが強調表示された自動化アプローチ ワークフロー図](images/ripu-workflow-hl-rollback.svg)

ロールバック後、ペット アプリケーション サーバーは、ワークフローのアップグレード フェーズに入る直前の状態に戻ります。

### Step 1 - ロールバックジョブテンプレートを起動する

このStepでは、ペットアプリケーションサーバーの 1 つで RHEL インプレースアップグレードをロールバックします。

- Web ブラウザーで AAP Web UI タブに戻ります。リソース > テンプレート に移動し、"AUTO / 03 Rollback" ジョブ テンプレートを開きます。表示は次のようになります:

![ロールバック ジョブ テンプレートの詳細ビューを表示する AAP Web UI](images/rollback_template.svg)

- [起動] ボタンをクリックすると、制限と変数のプロンプトから始まるジョブを送信するためのプロンプトが表示されます。ロールバックを実行するのは 1 つのサーバーのみです。これを行うには、[制限] プロンプトの下に、選択したペット アプリ サーバーのホスト名を入力します。例:

![ロールバック ジョブの制限と変数のプロンプトを表示する AAP Web UI](images/rollback_prompts.svg)

[次へ] ボタンをクリックして続行します。

![ロールバック ジョブの調査プロンプトを表示する AAP Web UI](images/rollback_survey.svg)

- 次に、インベントリ グループを選択するように求めるジョブ テンプレートの調査プロンプトが表示されます。ジョブを 1 つのサーバーに制限したので、"ALL_rhel" オプションを選択して "次へ" ボタンをクリックします。これにより、選択したジョブ オプションと変数設定のプレビューが表示されます。例:

![ロールバック ジョブのプレビュー プロンプトを表示する AAP Web UI](images/rollback_preview.svg)

すべてが問題なければ、"起動" ボタンを使用して Playbook ジョブを開始します。

### Step 2 - ロールバック ジョブの出力を確認する

ロールバック Playbook ジョブを起動すると、AAP Web UI は自動的にジョブ出力ページに移動します。

- 自動ロールバックの実行には数分しかかかりません。Playbook の実行が進むにつれて、ログ出力を監視できます。

- ジョブの実行が終了したら、ジョブ出力の一番下までスクロールします。正常に終了した場合は、次の例のようにジョブの概要に "failed=0" ステータスが表示されます。

![ジョブ出力の最後に表示されるロールバック ジョブ「PLAY RECAP」](images/rollback_job_recap.svg)

上記の例では、ジョブが 3 分弱で完了していることがわかります。ただし、その時間のほとんどは、スナップショットのマージがバックグラウンドで完了するまでジョブを保留する最後の「スナップショットが排出されるのを待つ」タスクに費やされました。インスタンスは実際には 1 分弱でロールバックされ、サービスの準備が整いました。すばらしいと思いませんか?

### Step 3 - RHEL バージョンの確認

[演習 2.3: Step 2](../2.3-check-upg/README.ja.md#step-2---ホストが次の-rhel-バージョンにアップグレードされたことを確認する) で実行した手順を繰り返し、今度は RHEL バージョンが元に戻っていることを確認します。

- たとえば、ロールバックしたペット アプリ ホストが RHEL7 から RHEL8 にアップグレードされていた場合、RHEL7 に戻っていることがわかります。

![ホストが RHEL7 インストールに戻っていることを示すコマンド出力](images/commands_after_rollback.svg)

## まとめ

この演習では、自動化を使用して RHEL インプレース アップグレードをすばやく元に戻し、アプリ サーバーを元の状態に戻しました。

次の演習では、アップグレードによって発生したすべての変更と影響が元に戻っていることをさらに詳しく検証します。

---

**ナビゲーション**

[前の演習](../3.1-rm-rf/README.ja.md) - [次の演習](../3.3-check-undo/README.ja.md)

[ホーム](../README.ja.md)
