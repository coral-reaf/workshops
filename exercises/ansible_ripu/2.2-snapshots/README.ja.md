# ワークショップ演習 - スナップショットについてお話しましょう

## 目次

- [ワークショップ演習 - スナップショットについてお話しましょう](#workshop-exercise---スナップショットについてお話しましょう)
  - [目次](#目次)
  - [目的](#目的)
  - [ガイド](#ガイド)
    - [Step 1 - スナップショットとは何か、またそうではないものは何か](#step-1---スナップショットとは何か、またそうではないものは何か)
    - [Step 2 - さまざまなスナップショットソリューションの評価](#step-2---さまざまなスナップショットソリューションの評価)
      - [LVM](#lvm)
      - [VMware](#vmware)
      - [Amazon EBS](#amazon-ebs)
      - [ミラーの解除](#ミラーの解除)
      - [ReaR](#rear)
    - [Step 3 - スナップショットの範囲](#スナップショットの範囲)
    - [Step 4 - 最適なスナップショットソリューションの選択](#step-4---最適なスナップショットソリューションの選択)
  - [まとめ](#まとめ)

## 目標

* バックアップとスナップショットの違いを理解する
* スナップショットを実行するさまざまな方法について学習する
* スナップショットの自動化で遭遇する可能性のある課題や障壁に備える
* 組織に適したスナップショットの範囲を検討する

## ガイド

前回の演習では、ペット アプリケーション サーバーの RHEL インプレース アップグレードを開始するための自動化を開始しました。アップグレード ワークフロー テンプレートの最初のステップは、アップグレードする各 RHEL インスタンスのスナップショットを作成することです。アップグレードで問題が発生した場合、スナップショットによりアップグレードをすばやく元に戻すことができます。

スナップショットの自動化は、RHEL インプレース アップグレード ソリューション アプローチの最も難しい機能の 1 つです。この演習では、企業が直面するいくつかの課題を検討し、それらを克服するための戦略を検討します。

まず、スナップショットについて話すときに何を意味するのかを正確に定義することから始めましょう。

### ステップ 1 - スナップショットとは何か、またそうでないものは何か

成熟した従来のコンピューティング環境を持つほとんどの組織では、バックアップを実行するための標準とツールが実装されています。通常、バックアップは定期的なスケジュールで実行されます。より重要なデータやより動的なデータは、ほとんどが静的なデータよりも頻繁にバックアップされる可能性があります。多くの場合、完全バックアップはたまにしか実行せず、変更されたファイルをより頻繁に保存するために増分バックアップを使用する戦略があります。

バックアップを実行する理由は、何らかの理由で失われたデータを回復できるようにするためです。操作上の問題やソフトウェアの欠陥、または誤って削除されたためにデータが破損した場合、バックアップを使用すると時計を戻して失われたデータを簡単に復元できます。

ただし、サーバー全体が失われた場合、バックアップを使用して回復するのはより困難です。バックアップから何かを復元するには、まず新しいオペレーティング システムをインストールする必要があります。データは完全バックアップと複数の増分バックアップに分散される可能性があり、完全なサーバー回復にかかる時間がさらに長くなります。ほとんどの組織では、バックアップ ソリューションを個々のファイルやディレクトリの復元にのみ使用していますが、サーバー上のすべてのものを復元する準備は整っていません。たとえ整っていたとしても、そのような復元には長い時間がかかります。

スナップショットは、個々のファイルをバックアップおよび復元しないという点で異なります。代わりに、バックアップはストレージ デバイス レベルで動作し、論理ボリュームまたは仮想ディスク全体の内容を即座に保存します。バックアップとは異なり、スナップショットはバックアップされるデータのコピーを作成するのではなく、変更されたすべてのデータのコピーがコピーされる時点をマークします。このため、スナップショットに使用される基礎技術は、「コピー オン ライト」または COW と呼ばれることがよくあります。

COW スナップショットは、従来の完全バックアップや増分バックアップの代替にはなりませんが、いくつかの利点があります。最も重要な利点は、従来のバックアップと復元では数時間以上かかるのに対し、スナップショットの作成とロールバックはほぼ瞬時に行われることです。サーバー全体を迅速に過去に戻すことができるため、スナップショットは RHEL インプレース アップグレードを実行するリスクを軽減するのに最適です。

### Step 2 - さまざまなスナップショットソリューションの評価

選択できるスナップショット ソリューションにはさまざまな種類があります。それぞれに利点と欠点があり、次の表にまとめられています。:

| スナップショットの種類 | 機能 | 利点 | 欠点 |
| ------------- | --------- | -------- | -------- |
| LVM |<ul><li>ベアメタル</li><li>オンプレミス VM</li><li>クラウド*</li></ul>|<ul><li>外部 API アクセスは不要</li><li>スコープは OS のみまたはすべて</li></ul>|<ul><li>ボリューム グループに空き領域が必要</li>サイズが適切でない場合、スナップショットの領域が不足する可能性があります</li><li>自動化では /boot を個別にバックアップおよび復元する必要があります</ul>|
| VMware |<ul><li>オンプレミス VM (ESX)</li></ul>|<ul><li>シンプルで信頼性が高い</li><li>スコープにすべてが含まれる</li></ul>|<ul><li>ベアメタルなどはサポートされていません</li><li>VMware スナップショットを 3 日以上使用することは推奨されません</li><li>API アクセスの取得が困難な場合があります</li><li>オーバーコミットメントのため、データストアに空き領域がありません</li><li>すべてをスコープにすると大きすぎる場合があります</li></ul>|
| Amazon EBS |<ul><li>Amazon EC2</li></ul>|<ul><li>シンプルで信頼性が高い</li><li>無制限のストレージ容量</li><li>スコープは OS のみ、またはすべてにすることができます</li></ul>|<ul><li>AWS でのみ機能します</li></ul>|
|ミラーの解除 |<ul><li>ベア メタル</li></ul>|<ul><li>ハードウェア RAID 搭載サーバー用の LVM の代替</li></ul>|<ul><li>開発とテストに多大な労力が必要</li><li>RAID および Redfish API 標準は、ベンダーやハードウェア モデルによって異なります</li></ul>|
| ReaR |<ul><li>ベア メタル</li><li>オンプレミスの VM</li></ul>|<ul><li>スナップショット オプションが機能しない場合の最後の手段</li></ul>|<ul><li>実際にはスナップショットではありませんが、ブート ISO の完全回復機能を提供します</li></ul>|

次のセクションでは、長所と短所について詳しく説明します。

#### LVM

論理ボリューム マネージャー (LVM) は、RHEL に含まれるツール セットで、論理ボリュームと呼ばれる仮想ブロック デバイスを作成および管理する方法を提供します。LVM 論理ボリュームは通常、RHEL OS ファイルシステムがマウントされるブロック デバイスとして使用されます。LVM ツールは、論理ボリューム スナップショットの作成とロールバックをサポートします。Ansible プレイブックからこれらのアクションを自動化するのは比較的簡単です。

> **注記**
>
> ワークショップ ラボ環境に実装されたスナップショットおよびロールバック自動化機能は、[`infra.lvm_snapshots`](https://github.com/swapdisk/infra.lvm_snapshots#readme) コレクションの Ansible ロールを使用して管理される LVM スナップショットを作成します。

論理ボリュームは、ボリューム グループと呼ばれるストレージ プールに含まれています。ボリューム グループで使用可能なストレージは、1 つ以上の物理ボリューム、つまり実際のディスクまたはディスク パーティションの基盤となるブロック デバイスから取得されます。通常、RHEL OS がインストールされている論理ボリュームは、「rootvg」ボリューム グループにあります。ベスト プラクティスに従うと、アプリケーションとアプリ データは、同じボリューム グループまたは別のボリューム グループ (たとえば「appvg」) 内の独自の論理ボリュームに分離されます。

論理ボリュームのスナップショットを作成するには、ボリューム グループに空き領域が必要です。つまり、ボリューム グループ内の論理ボリュームの合計サイズは、ボリューム グループの合計サイズよりも小さくする必要があります。ボリューム グループの空き領域を照会するには、`vgs` コマンドを使用できます。例:

```
# vgs
VG #PV #LV #SN Attr VSize VFree
VolGroup00 1 7 0 wz--n- 29.53g 9.53g
```

上記の例では、`VolGroup00` ボリューム グループの合計サイズは 29.53 GiB で、ボリューム グループには 9.53 GiB の空き領域があります。これは、RHEL アップグレードのロールバックをサポートするのに十分な空き領域です。

ボリューム グループに十分な空き領域がない場合、スペースを利用できるようにする方法がいくつかあります。

- ボリューム グループに別の物理ボリュームを追加する (つまり、`pvcreate` および `vgextend`)。VM の場合は、最初に追加の仮想ディスクを構成します。
- 不要な論理ボリュームを一時的に削除します。たとえば、ベア メタル サーバーでは、多くの場合、/var/crash という大きな空のファイル システムがあります。このファイル システムを `/etc/fstab` から削除し、`lvremove` を使用して、マウントされている論理ボリュームを削除すると、ボリューム グループのスペースが解放されます。
- 1 つ以上の論理ボリュームのサイズを縮小します。これは、まず論理ボリューム内のファイル システムを縮小する必要があるため、注意が必要です。XFS ファイル システムは縮小をサポートしていません。EXT ファイル システムは縮小をサポートしていますが、ファイル システムがマウントされている間は縮小できません。最近まで、ボリューム グループのスペースを解放するこの方法は、最も熟練した Linux 管理者だけが試みる最後の手段と考えられていましたが、今では前述の `infra.lvm_snapshots` コレクションの [`shrink_lv`](https://github.com/swapdisk/infra.lvm_snapshots/tree/main/roles/shrink_lv#readme) ロールを使用して、論理ボリュームの縮小を安全に自動化できます。

スナップショットが作成されると、ブロックが元の論理ボリュームに書き込まれるため、COW データはスナップショット論理ボリュームの空き領域を利用し始めます。スナップショットが元のサイズと同じサイズで作成されない限り、スナップショットがいっぱいになって無効になる可能性があります。これを防ぐために十分な余裕のあるスナップショットのサイズを決定するために、LVM スナップショット自動化の開発中にテストを実行する必要があります。 lvm.conf の `snapshot_autoextend_percent` および `snapshot_autoextend_threshold` 設定を使用して、スナップショットの容量が不足するリスクを軽減することもできます。`infra.lvm_snapshots` コレクションの [`lvm_snapshots`](https://github.com/swapdisk/infra.lvm_snapshots/tree/main/roles/lvm_snapshots#readme) ロールは、自動拡張設定を自動的に構成するために使用できる変数をサポートしています。

元のボリュームと同じサイズのスナップショットを作成できる余裕がない限り、LVM スナップショットのサイズ設定を徹底的にテストし、空き容量の使用状況を注意深く監視する必要があります。ただし、その課題を解決できれば、LVM スナップショットは、VMware などの外部インフラストラクチャに依存する手間をかけずに、信頼性の高いスナップショット ソリューションを提供します。

#### VMware

VMware スナップショットは、特定の時点での VM の状態とデータを保存します。VMware スナップショットはハイパーバイザー レベルで動作するため、ゲスト OS から完全に独立しています。そのため、RHEL のアップグレード中に問題が発生した場合でも、VMware スナップショットは完全に保護されます。アップグレードがひどく失敗して OS が再起動できない場合でも、VMware スナップショットを元に戻せば状況は改善されます。これらの理由から、VMware スナップショットは非常に魅力的なスナップショット オプションであると考えられます。

VMware スナップショットは、vSphere 管理 UI を使用して手動で作成および元に戻すことができます。Ansible プレイブックから VMware スナップショットを自動的に作成または元に戻すには、必要な vSphere API 呼び出しへのアクセス権限を AAP コントロール ノードに許可する必要があります。

当社の経験では、このアクセスを許可するのは非常に困難です。ほとんどの組織で VMware 環境を管理するチームは、vSphere 管理 UI を使用してすべてを手動で行う「ClickOps」モデルに深く関わっています。また、チーム外で開発された自動化が、スナップショットが作成される VMFS データ ストアに十分な空き容量があるかどうかの確認など、VMware スナップショットを作成するために手動で行う操作を実行できるかどうかについても、信頼できない可能性があります。

VMware チームは、ストレージ容量が限られているため、スナップショットのサポートに抵抗する可能性があります。標準の VMDK ファイルのサイズは固定されていますが、COW スナップショットは時間の経過とともに大きくなり、VMware 環境のデータ ストアが容量不足になることが多いため、注意深い監視が必要です。

自動スナップショットのサポートに抵抗するもう 1 つの理由は、スナップショットは 72 時間を超えて使用してはならないという VMware ベンダーの推奨事項です (KB 記事 [Best practices for using VMware snapshots in the vSphere environment](https://kb.vmware.com/s/article/1025279) を参照)。残念ながら、アプリケーション チームは通常、RHEL のアップグレードによってアプリケーションに影響がないと確信するまでに 3 日以上のソーク時間を必要とします。

VMware スナップショットは、自動化できる場合に非常に効果的です。このオプションを検討している場合は、組織の VMware 環境を管理するチームと早期に連携し、潜在的な抵抗に備えてください。

#### Amazon EBS

Amazon Elastic Block Store (Amazon EBS) は、AWS EC2 インスタンスに接続された仮想ディスクに使用されるブロック ストレージ ボリュームを提供します。EBS ボリュームのスナップショットが作成されると、COW データが Amazon S3 オブジェクト ストレージに書き込まれます。

EBS スナップショットは EC2 インスタンスで実行されているゲスト OS とは独立して動作しますが、VMware スナップショットとの類似点はそれだけです。EBS スナップショットはソース EBS ボリュームのデータを保存しますが、ボリュームが接続されている EC2 インスタンスの状態やメモリは保存しません。また、VMware とは異なり、EBS スナップショットは OS ボリュームに対してのみ作成でき、個別のアプリケーションボリュームはそのままにしておくことができます。

EBS スナップショットの作成とロールバックの自動化は、Playbook が必要な AWS API にアクセスできると仮定すると、かなり簡単です。自動化の難しい部分は、AAP によって管理される Ansible インベントリ内のターゲット ホストに対応する EC2 インスタンスと接続された EBS ボリュームを識別することですが、これは EC2 インスタンスに識別タグを設定することで解決できます。

#### ミラーの解除

この方法は、ルート ディスクがハードウェア RAID ミラー セット上にあるベア メタル サーバーで使用できる LVM の代替手段です。技術的にはスナップショットではありませんが、ほぼ瞬時のロールバック機能を提供します。

アップグレードを開始する直前にスナップショットを作成する代わりに、自動化によって RAID コントローラーが再構成され、ルート ディスクのミラー セットが解除されて JBOD ディスクが 2 つだけになります。JBOD ディスクの 1 つはアップグレードで使用され、もう 1 つはそのまま残ります。ロールバックを実行するには、ミラー セットがそのままの JBOD から再構築されます。

ほとんどのベア メタル サーバーは帯域外管理をサポートしており、過去 10 年間に製造されたサーバーは [Redfish](https://www.dmtf.org/standards/redfish) 標準に基づく API をサポートします。これらの API は、自動化によってミラー セットを破棄して再構築するために使用できますが、API 実装はベンダーやサーバー モデルによって必ずしも同じではないため、開発とテストに多大な労力がかかることを覚悟してください。

#### ReaR

ReaR (Relax and Recover) は、RHEL に含まれているバックアップおよびリカバリ ツールです。ReaR はスナップショットを使用しませんが、RHEL サーバーの完全バックアップと復元を非常に簡単に実行できます。完全バックアップを実行すると、ReaR はサーバーの現在の状態を含む起動可能な ISO イメージを作成します。ReaR バックアップを使用してインプレース アップグレードを元に戻すには、サーバーを ISO イメージから起動し、メニューから [自動リカバリ] オプションを選択するだけです。

ReaR のバックアップとリカバリは、スナップショットのロールバックのように瞬時に行われるわけではありませんが、OS の新規インストールを実行してからファイル レベルで手動でリカバリする必要があるリカバリ ツールと比較すると、非常に高速です。

詳細については、記事 [ReaR: Linux サーバーを自信を持ってバックアップおよびリカバリする](https://www.redhat.com/sysadmin/rear-backup-and-recover) をお読みください。

### Step 3 - スナップショットの範囲

RHEL サーバーのローカル ストレージを割り当てるためのベスト プラクティスは、OS をアプリおよびアプリ データから分離するボリュームを構成することです。たとえば、OS ファイルシステムは「rootvg」ボリューム グループの下にあり、アプリおよびアプリ データは「appvg」ボリューム グループ内、または少なくとも専用の論理ボリューム内にあります。この分離により、これら 2 つのグループのストレージ使用要件が分離され、個々の要件に基づいて管理できるようになり、相互に影響を与える可能性が低くなります。たとえば、OS のバックアップ プロファイルは、アプリおよびアプリ データのバックアップ プロファイルとは異なる可能性があります。

このプラクティスは、RHEL インプレース アップグレード アプローチの重要な原則、つまり、システム ライブラリの前方互換性とミドルウェア ランタイムの抽象化によって、RHEL アップグレードがアプリの機能に影響を与えるリスクが軽減されるという期待のもと、OS アップグレードではアプリケーションをそのまま残すという原則を強制するのに役立ちます。

これらの概念を念頭に置いて、RHEL アップグレードを元に戻す必要がある場合にロールバックする対象にアプリおよびアプリ データを含めるかどうかを検討してみましょう。

| スナップショットの範囲 | 利点 |欠点 |
| -------------- | -------- | --------- |
| OS のみ |<ul><li>ストレージ要件が簡素化されます</li><li>OS の変更とアプリおよびアプリ データの分離が維持されます</li><li>外部アプリに影響を与えるロールバックのリスクが軽減されます</li></ul>|<ul><li>VMware スナップショットではおそらく不可能です</li><li>影響を修正するためにアプリをすぐに変更しようとする誘惑を避けるための規律が必要です</li></ul>|
| OS とアプリ/データ |<ul><li>メンテナンス ウィンドウ中にアプリの影響を修正しようとする場合のリスクが軽減されます</li><li>アプリの影響によってアプリ データが破損する可能性がある場合に役立ちます</li></ul>|<ul><li>より多くのストレージ領域が必要です</li><li>アプリ データをロールバックすると外部システムに影響を与える可能性があります</li></ul>|

スナップショットにアップグレードされた OS ボリュームのみが含まれる場合、OS の変更とアプリの変更を分離するというベスト プラクティスに従います。この場合、RHEL アップグレード後のアプリケーションへの影響に直面してロールバックを回避するために、大胆なアプリ変更を行う誘惑に抵抗することが重要です。安全性と健全性のために、アプリへの影響の原因を理解するのに役立つ証拠を収集してから、ロールバックを実行します。OS をロールバックした後に解明が困難になる可能性のあるアプリ変更は行わないでください。

残念ながら、VMware スナップショットは、OS またはアプリ データが含まれているかどうかに関係なく、すべての仮想ディスクを含む VM インスタンスの完全な状態を保存します。これは、いくつかの理由で困難になる可能性があります。まず、スナップショットに必要なストレージ領域が増え、アプリ データのアクティビティによってスナップショットがどの程度増加するかを予測するのが難しくなります。もう 1 つの問題は、アプリ データをロールバックすると、アプリの状態が外部システムと同期しなくなり、予期しない問題が発生する可能性があることです。何らかの理由でアプリ データをロールバックする場合は、発生する可能性のある潜在的な問題に注意してください。

### Step 4 - 最適なスナップショットソリューションの選択

スナップショット/ロールバックのどの方法が環境に最適かを判断する際に考慮すべき要素がいくつかあります。

- ベアメタル サーバーと VMware またはクラウド インスタンスの混合はどのようなものですか?
- 空き領域を最も簡単に利用できる場所はどこですか?
- VMware インベントリと vSphere API に自由にアクセスできますか?
- 組織にとって適切なスナップショットの範囲はどれですか?
- 最も簡単に完全に自動化できるスナップショット ソリューションはどれですか?

ベルトとサスペンダーのアプローチを検討してください。つまり、複数の方法をサポートします。ベアメタル用に 1 つの方法を推奨し、VM 用に別の方法を推奨するのが理にかなっているかもしれません。

どのような決定を下す場合でも、エンドツーエンドの自動化と統合された効果的なスナップショット/ロールバック機能が、RHEL インプレース アップグレード ソリューションの最も重要な機能であることを忘れないでください。

## まとめ

この演習では、自動化されたスナップショット/ロールバック機能を実現するさまざまな方法の長所と短所について学習しました。また、OS の変更から分離されていないアプリ データをロールバックすることで発生する可能性のあるリスクについても検討しました。この知識があれば、スナップショット/ロールバック自動化アプローチを設計する際に、より情報に基づいた決定を下すことができます。

次の演習では、ペット アプリケーション サーバーで RHEL インプレース アップグレードがどのように進行しているかをもう一度確認します。

---

**ナビゲーション**

[Previous Exercise](../2.1-upgrade/README.ja.md) - [Next Exercise](../2.3-check-upg/README.ja.md)

[Home](../README.ja.md)
